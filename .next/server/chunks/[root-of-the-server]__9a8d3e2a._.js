module.exports = {

"[project]/.next-internal/server/app/api/process-study-material/route/actions.js [app-rsc] (server actions loader, ecmascript)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
}}),
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}}),
"[externals]/child_process [external] (child_process, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("child_process", () => require("child_process"));

module.exports = mod;
}}),
"[externals]/fs [external] (fs, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("fs", () => require("fs"));

module.exports = mod;
}}),
"[externals]/https [external] (https, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("https", () => require("https"));

module.exports = mod;
}}),
"[externals]/stream [external] (stream, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}}),
"[externals]/os [external] (os, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("os", () => require("os"));

module.exports = mod;
}}),
"[externals]/events [external] (events, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("events", () => require("events"));

module.exports = mod;
}}),
"[externals]/process [external] (process, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("process", () => require("process"));

module.exports = mod;
}}),
"[externals]/util [external] (util, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("util", () => require("util"));

module.exports = mod;
}}),
"[externals]/path [external] (path, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("path", () => require("path"));

module.exports = mod;
}}),
"[externals]/crypto [external] (crypto, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("crypto", () => require("crypto"));

module.exports = mod;
}}),
"[externals]/querystring [external] (querystring, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("querystring", () => require("querystring"));

module.exports = mod;
}}),
"[externals]/buffer [external] (buffer, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("buffer", () => require("buffer"));

module.exports = mod;
}}),
"[externals]/fs/promises [external] (fs/promises, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("fs/promises", () => require("fs/promises"));

module.exports = mod;
}}),
"[externals]/node:stream [external] (node:stream, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("node:stream", () => require("node:stream"));

module.exports = mod;
}}),
"[externals]/node:stream/promises [external] (node:stream/promises, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("node:stream/promises", () => require("node:stream/promises"));

module.exports = mod;
}}),
"[externals]/http [external] (http, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("http", () => require("http"));

module.exports = mod;
}}),
"[externals]/net [external] (net, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("net", () => require("net"));

module.exports = mod;
}}),
"[externals]/tls [external] (tls, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("tls", () => require("tls"));

module.exports = mod;
}}),
"[externals]/url [external] (url, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}}),
"[externals]/zlib [external] (zlib, cjs)": ((__turbopack_context__) => {

var { m: module, e: exports } = __turbopack_context__;
{
const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}}),
"[project]/src/app/api/process-study-material/route.ts [app-route] (ecmascript)": ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s({
    "POST": ()=>POST,
    "runtime": ()=>runtime
});
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$google$2f$genai$2f$dist$2f$node$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/@google/genai/dist/node/index.mjs [app-route] (ecmascript)");
;
;
const runtime = "nodejs";
function clampInt(n, min, max) {
    if (!Number.isFinite(n)) return min;
    return Math.max(min, Math.min(max, Math.trunc(n)));
}
function sleep(ms) {
    return new Promise((r)=>setTimeout(r, ms));
}
function getGeminiKey() {
    return process.env.GEMINI_API_KEY || process.env.GOOGLE_API_KEY || "";
}
/** Pega status/code e retryDelay mesmo quando vem JSON dentro de message */ function parseGeminiError(err) {
    const rawMsg = String(err?.message || err || "");
    const statusFromObj = typeof err?.status === "number" && err.status || typeof err?.code === "number" && err.code || null;
    let status = statusFromObj;
    let message = rawMsg;
    let retryAfterSeconds = null;
    // tenta extrair JSON dentro da mensagem
    const start = rawMsg.indexOf("{");
    const end = rawMsg.lastIndexOf("}");
    if (start >= 0 && end > start) {
        const slice = rawMsg.slice(start, end + 1);
        try {
            const parsed = JSON.parse(slice);
            const apiErr = parsed?.error;
            if (apiErr) {
                if (typeof apiErr.code === "number") status = apiErr.code;
                if (typeof apiErr.message === "string") message = apiErr.message;
                const details = Array.isArray(apiErr.details) ? apiErr.details : [];
                const retryInfo = details.find((d)=>String(d?.["@type"] || "").includes("RetryInfo"));
                const retryDelay = retryInfo?.retryDelay;
                if (retryDelay) {
                    const m = String(retryDelay).match(/([0-9]+(?:\.[0-9]+)?)\s*s/i);
                    if (m) retryAfterSeconds = Math.ceil(Number(m[1]));
                }
            }
        } catch  {
        // ignore
        }
    }
    // fallback: "Please retry in XXs"
    if (!retryAfterSeconds) {
        const m2 = rawMsg.match(/retry in\s+([0-9.]+)s/i);
        if (m2) retryAfterSeconds = Math.ceil(Number(m2[1]));
    }
    return {
        status,
        message,
        retryAfterSeconds
    };
}
function isQuota429(err) {
    const p = parseGeminiError(err);
    if (p.status === 429) return true;
    const msg = p.message.toLowerCase();
    return msg.includes("quota exceeded") || msg.includes("resource_exhausted");
}
function isNotFound404(err) {
    const p = parseGeminiError(err);
    if (p.status === 404) return true;
    return p.message.toLowerCase().includes("not found");
}
function isOverloaded503(err) {
    const p = parseGeminiError(err);
    if (p.status === 503) return true;
    const msg = p.message.toLowerCase();
    return msg.includes("overloaded") || msg.includes("unavailable");
}
function getStudySchema() {
    return {
        type: "object",
        required: [
            "topic",
            "flashcards",
            "summary"
        ],
        properties: {
            topic: {
                type: "string"
            },
            tags: {
                type: "array",
                items: {
                    type: "string"
                }
            },
            flashcards: {
                type: "array",
                items: {
                    type: "object",
                    required: [
                        "id",
                        "question",
                        "answer"
                    ],
                    properties: {
                        id: {
                            type: "integer"
                        },
                        question: {
                            type: "string"
                        },
                        answer: {
                            type: "string"
                        },
                        difficulty: {
                            type: "string"
                        },
                        tags: {
                            type: "array",
                            items: {
                                type: "string"
                            }
                        }
                    }
                }
            },
            summary: {
                type: "object",
                required: [
                    "title",
                    "mainTopics",
                    "keyPoints"
                ],
                properties: {
                    title: {
                        type: "string"
                    },
                    length: {
                        type: "string"
                    },
                    mainTopics: {
                        type: "array",
                        items: {
                            type: "object",
                            required: [
                                "id",
                                "title",
                                "content",
                                "icon"
                            ],
                            properties: {
                                id: {
                                    type: "integer"
                                },
                                title: {
                                    type: "string"
                                },
                                content: {
                                    type: "string"
                                },
                                icon: {
                                    type: "string"
                                },
                                tags: {
                                    type: "array",
                                    items: {
                                        type: "string"
                                    }
                                }
                            }
                        }
                    },
                    keyPoints: {
                        type: "array",
                        items: {
                            type: "string"
                        }
                    },
                    sourceQuotes: {
                        type: "array",
                        items: {
                            type: "object",
                            required: [
                                "quote",
                                "whyItMatters"
                            ],
                            properties: {
                                quote: {
                                    type: "string"
                                },
                                whyItMatters: {
                                    type: "string"
                                }
                            }
                        }
                    }
                }
            }
        }
    };
}
function buildPromptText(params) {
    const diffText = params.difficulty === "random" ? "Misture dificuldades (easy/medium/hard) e preencha difficulty em cada flashcard." : `Use difficulty="${params.difficulty}" em todos os flashcards.`;
    const summaryText = params.summaryStyle === "bullets" ? "Resumo objetivo em bullets curtos." : "Resumo elaborado e explicativo (parÃ¡grafos didÃ¡ticos).";
    const base = `Gere APENAS JSON vÃ¡lido (sem markdown, sem texto fora do JSON).

Regras:
- Crie EXATAMENTE ${params.flashcardsCount} flashcards.
- ${diffText}
- ${summaryText}
- Preencha summary.length com "short", "medium" ou "long".
- Use emojis em icon.

Formato:
{
  "topic": "TÃ³pico principal",
  "tags": ["tag1"],
  "flashcards": [{ "id": 1, "question": "...", "answer": "...", "difficulty": "easy" }],
  "summary": {
    "title": "TÃ­tulo",
    "length": "short|medium|long",
    "mainTopics": [{ "id": 1, "title": "...", "content": "...", "icon": "ðŸ“Œ" }],
    "keyPoints": ["..."],
    "sourceQuotes": [{ "quote": "...", "whyItMatters": "..." }]
  }
}`;
    if (!params.isImage && !params.isPdf) {
        const snippet = (params.textSnippet || "").slice(0, 4000);
        return `Material (trecho):\n${snippet}\n\n${base}`;
    }
    return base;
}
async function runGeminiOnce(params) {
    const apiKey = getGeminiKey();
    if (!apiKey.trim()) throw new Error("GEMINI_API_KEY/GOOGLE_API_KEY ausente no .env.local.");
    const ai = new __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f40$google$2f$genai$2f$dist$2f$node$2f$index$2e$mjs__$5b$app$2d$route$5d$__$28$ecmascript$29$__["GoogleGenAI"]({
        apiKey
    });
    const contents = params.isImage || params.isPdf ? [
        {
            inlineData: {
                mimeType: params.mimeType,
                data: params.base64
            }
        },
        {
            text: params.prompt
        }
    ] : [
        {
            text: params.prompt
        }
    ];
    const resp = await ai.models.generateContent({
        model: params.model,
        contents,
        config: {
            systemInstruction: "VocÃª Ã© um assistente educacional. Responda apenas em JSON conforme o schema.",
            responseMimeType: "application/json",
            responseJsonSchema: getStudySchema()
        }
    });
    const raw = resp.text || "";
    if (!raw.trim()) throw new Error("Gemini retornou resposta vazia.");
    return JSON.parse(raw);
}
async function runGeminiWithFallback(params) {
    // âœ… Lite primeiro. Preferido vem do .env (recomendado: gemini-2.0-flash-lite)
    const preferred = process.env.GEMINI_MODEL || "gemini-2.0-flash-lite";
    const models = [
        preferred,
        "gemini-2.0-flash-lite",
        "gemini-2.5-flash-lite",
        "gemini-2.0-flash",
        "gemini-2.5-flash",
        "gemini-flash-latest"
    ].filter(Boolean);
    let lastErr = null;
    let lastQuota = null;
    for (const model of models){
        // retry sÃ³ para 503
        const retries503 = 2;
        for(let attempt = 0; attempt <= retries503; attempt++){
            try {
                return await runGeminiOnce({
                    model,
                    ...params
                });
            } catch (e) {
                lastErr = e;
                // 404 => tenta prÃ³ximo modelo
                if (isNotFound404(e)) break;
                // 429 => guarda info e tenta prÃ³ximo modelo (SEM esperar 40s no backend)
                if (isQuota429(e)) {
                    const p = parseGeminiError(e);
                    lastQuota = {
                        retryAfterSeconds: p.retryAfterSeconds,
                        message: p.message
                    };
                    break;
                }
                // 503 => retry com backoff
                if (isOverloaded503(e)) {
                    const backoff = 900 * Math.pow(2, attempt) + Math.floor(Math.random() * 250);
                    await sleep(backoff);
                    continue;
                }
                // outro erro => sobe
                throw e;
            }
        }
    }
    // Se tudo caiu em quota, sobe um erro especial (pra virar 429 na resposta)
    if (lastQuota) {
        const err = new Error(lastQuota.message || "Quota exceeded");
        err.status = 429;
        err.retryAfterSeconds = lastQuota.retryAfterSeconds ?? 45;
        throw err;
    }
    throw lastErr || new Error("Falha ao chamar Gemini (todos os modelos falharam).");
}
async function POST(request) {
    try {
        // SÃ³ gemini aqui (vocÃª estÃ¡ usando a key do Google)
        const apiKey = getGeminiKey();
        if (!apiKey.trim()) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                success: false,
                error: "Defina GEMINI_API_KEY/GOOGLE_API_KEY no .env.local."
            }, {
                status: 500
            });
        }
        const formData = await request.formData();
        const file = formData.get("file");
        if (!file) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                success: false,
                error: "Nenhum arquivo foi enviado"
            }, {
                status: 400
            });
        }
        const flashcardsCount = clampInt(Number(formData.get("flashcardsCount") || 10), 1, 50);
        const difficulty = String(formData.get("flashcardsDifficulty") || "random");
        const summaryStyle = String(formData.get("summaryStyle") || "bullets");
        const bytes = await file.arrayBuffer();
        const buffer = Buffer.from(bytes);
        const mimeType = file.type || "application/octet-stream";
        const base64 = buffer.toString("base64");
        const isImage = mimeType.startsWith("image/");
        const isPdf = mimeType === "application/pdf";
        const textSnippet = !isImage && !isPdf ? buffer.toString("utf-8") : undefined;
        const prompt = buildPromptText({
            flashcardsCount,
            difficulty,
            summaryStyle,
            isImage,
            isPdf,
            textSnippet
        });
        const data = await runGeminiWithFallback({
            prompt,
            mimeType,
            base64,
            isImage,
            isPdf
        });
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            success: true,
            data
        });
    } catch (error) {
        console.error("Erro ao processar arquivo:", error);
        // âœ… Se for quota, responde 429 (NÃƒO 500)
        if (error?.status === 429 || isQuota429(error)) {
            const p = parseGeminiError(error);
            const retrySec = error?.retryAfterSeconds ?? p.retryAfterSeconds ?? 45;
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                success: false,
                error: "Limite da cota do Gemini atingido (tier grÃ¡tis).",
                details: p.message,
                retryAfterSeconds: retrySec
            }, {
                status: 429,
                headers: {
                    "Retry-After": String(retrySec)
                }
            });
        }
        const p = parseGeminiError(error);
        const status = p.status === 503 ? 503 : 500;
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            success: false,
            error: "Erro ao processar o arquivo",
            details: p.message
        }, {
            status
        });
    }
}
}),

};

//# sourceMappingURL=%5Broot-of-the-server%5D__9a8d3e2a._.js.map