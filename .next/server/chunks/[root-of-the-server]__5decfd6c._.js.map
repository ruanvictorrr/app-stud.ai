{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///Users/ruangalvao/ProjetosVS/Projetos%20Pessoais/stud.ai-app/app-stud.ai/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma?: PrismaClient;\n};\n\nexport const prisma =\n  globalForPrisma.prisma ??\n  new PrismaClient({\n    log: [\"error\", \"warn\"],\n  });\n\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = prisma;\n"],"names":[],"mappings":";;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,6HAAA,CAAA,eAAY,CAAC;IACf,KAAK;QAAC;QAAS;KAAO;AACxB;AAEF,wCAA2C,gBAAgB,MAAM,GAAG","debugId":null}},
    {"offset": {"line": 99, "column": 0}, "map": {"version":3,"sources":["file:///Users/ruangalvao/ProjetosVS/Projetos%20Pessoais/stud.ai-app/app-stud.ai/src/lib/auth.ts"],"sourcesContent":["import { cookies } from \"next/headers\";\nimport { randomBytes } from \"crypto\";\nimport bcrypt from \"bcryptjs\";\nimport { prisma } from \"@/lib/prisma\";\n\nconst SESSION_COOKIE = \"studai_session\";\nconst SESSION_DAYS = 30;\n\nfunction parseAdminEmails(): string[] {\n  const raw = process.env.ADMIN_EMAILS || \"\";\n  return raw\n    .split(\",\")\n    .map((s) => s.trim().toLowerCase())\n    .filter(Boolean);\n}\n\nexport function isAdminEmail(email: string): boolean {\n  const admins = parseAdminEmails();\n  return admins.includes(email.toLowerCase());\n}\n\nexport async function hashPassword(plain: string) {\n  const saltRounds = 12;\n  return bcrypt.hash(plain, saltRounds);\n}\n\nexport async function verifyPassword(plain: string, hash: string) {\n  return bcrypt.compare(plain, hash);\n}\n\nexport function makeSessionToken() {\n  return randomBytes(32).toString(\"hex\");\n}\n\nexport function sessionExpiryDate() {\n  const d = new Date();\n  d.setDate(d.getDate() + SESSION_DAYS);\n  return d;\n}\n\nexport async function createSession(userId: string) {\n  const sessionToken = makeSessionToken();\n  const expires = sessionExpiryDate();\n\n  await prisma.session.create({\n    data: {\n      userId,\n      sessionToken,\n      expires,\n    },\n  });\n\n  // seta cookie (httpOnly)\n  const cookieStore = await cookies();\n  cookieStore.set(SESSION_COOKIE, sessionToken, {\n    httpOnly: true,\n    sameSite: \"lax\",\n    secure: process.env.NODE_ENV === \"production\",\n    path: \"/\",\n    expires,\n  });\n\n  return { sessionToken, expires };\n}\n\nexport async function destroySession() {\n  const cookieStore = await cookies();\n  const token = cookieStore.get(SESSION_COOKIE)?.value;\n\n  if (token) {\n    await prisma.session.deleteMany({ where: { sessionToken: token } });\n  }\n\n  cookieStore.set(SESSION_COOKIE, \"\", {\n    httpOnly: true,\n    sameSite: \"lax\",\n    secure: process.env.NODE_ENV === \"production\",\n    path: \"/\",\n    expires: new Date(0),\n  });\n}\n\nexport async function getCurrentUser() {\n  const cookieStore = await cookies();\n  const token = cookieStore.get(SESSION_COOKIE)?.value;\n  if (!token) return null;\n\n  const session = await prisma.session.findUnique({\n    where: { sessionToken: token },\n    include: { user: true },\n  });\n\n  if (!session) return null;\n\n  // Expirada\n  if (session.expires.getTime() < Date.now()) {\n    await prisma.session.deleteMany({ where: { sessionToken: token } });\n    return null;\n  }\n\n  // Se email estiver na lista ADMIN_EMAILS, garante role ADMIN\n  const user = session.user;\n  if (user.email && isAdminEmail(user.email) && user.role !== \"ADMIN\") {\n    await prisma.user.update({\n      where: { id: user.id },\n      data: { role: \"ADMIN\" },\n    });\n    user.role = \"ADMIN\";\n  }\n\n  return user;\n}\n\nexport async function requireUser() {\n  const user = await getCurrentUser();\n  if (!user) throw new Error(\"UNAUTHORIZED\");\n  return user;\n}\n\nexport async function requireAdmin() {\n  const user = await requireUser();\n  if (user.role !== \"ADMIN\") throw new Error(\"FORBIDDEN\");\n  return user;\n}\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;AACA;AACA;AACA;;;;;AAEA,MAAM,iBAAiB;AACvB,MAAM,eAAe;AAErB,SAAS;IACP,MAAM,MAAM,QAAQ,GAAG,CAAC,YAAY,IAAI;IACxC,OAAO,IACJ,KAAK,CAAC,KACN,GAAG,CAAC,CAAC,IAAM,EAAE,IAAI,GAAG,WAAW,IAC/B,MAAM,CAAC;AACZ;AAEO,SAAS,aAAa,KAAa;IACxC,MAAM,SAAS;IACf,OAAO,OAAO,QAAQ,CAAC,MAAM,WAAW;AAC1C;AAEO,eAAe,aAAa,KAAa;IAC9C,MAAM,aAAa;IACnB,OAAO,mIAAA,CAAA,UAAM,CAAC,IAAI,CAAC,OAAO;AAC5B;AAEO,eAAe,eAAe,KAAa,EAAE,IAAY;IAC9D,OAAO,mIAAA,CAAA,UAAM,CAAC,OAAO,CAAC,OAAO;AAC/B;AAEO,SAAS;IACd,OAAO,CAAA,GAAA,qGAAA,CAAA,cAAW,AAAD,EAAE,IAAI,QAAQ,CAAC;AAClC;AAEO,SAAS;IACd,MAAM,IAAI,IAAI;IACd,EAAE,OAAO,CAAC,EAAE,OAAO,KAAK;IACxB,OAAO;AACT;AAEO,eAAe,cAAc,MAAc;IAChD,MAAM,eAAe;IACrB,MAAM,UAAU;IAEhB,MAAM,sHAAA,CAAA,SAAM,CAAC,OAAO,CAAC,MAAM,CAAC;QAC1B,MAAM;YACJ;YACA;YACA;QACF;IACF;IAEA,yBAAyB;IACzB,MAAM,cAAc,MAAM,CAAA,GAAA,iIAAA,CAAA,UAAO,AAAD;IAChC,YAAY,GAAG,CAAC,gBAAgB,cAAc;QAC5C,UAAU;QACV,UAAU;QACV,QAAQ,oDAAyB;QACjC,MAAM;QACN;IACF;IAEA,OAAO;QAAE;QAAc;IAAQ;AACjC;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,CAAA,GAAA,iIAAA,CAAA,UAAO,AAAD;IAChC,MAAM,QAAQ,YAAY,GAAG,CAAC,iBAAiB;IAE/C,IAAI,OAAO;QACT,MAAM,sHAAA,CAAA,SAAM,CAAC,OAAO,CAAC,UAAU,CAAC;YAAE,OAAO;gBAAE,cAAc;YAAM;QAAE;IACnE;IAEA,YAAY,GAAG,CAAC,gBAAgB,IAAI;QAClC,UAAU;QACV,UAAU;QACV,QAAQ,oDAAyB;QACjC,MAAM;QACN,SAAS,IAAI,KAAK;IACpB;AACF;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,CAAA,GAAA,iIAAA,CAAA,UAAO,AAAD;IAChC,MAAM,QAAQ,YAAY,GAAG,CAAC,iBAAiB;IAC/C,IAAI,CAAC,OAAO,OAAO;IAEnB,MAAM,UAAU,MAAM,sHAAA,CAAA,SAAM,CAAC,OAAO,CAAC,UAAU,CAAC;QAC9C,OAAO;YAAE,cAAc;QAAM;QAC7B,SAAS;YAAE,MAAM;QAAK;IACxB;IAEA,IAAI,CAAC,SAAS,OAAO;IAErB,WAAW;IACX,IAAI,QAAQ,OAAO,CAAC,OAAO,KAAK,KAAK,GAAG,IAAI;QAC1C,MAAM,sHAAA,CAAA,SAAM,CAAC,OAAO,CAAC,UAAU,CAAC;YAAE,OAAO;gBAAE,cAAc;YAAM;QAAE;QACjE,OAAO;IACT;IAEA,6DAA6D;IAC7D,MAAM,OAAO,QAAQ,IAAI;IACzB,IAAI,KAAK,KAAK,IAAI,aAAa,KAAK,KAAK,KAAK,KAAK,IAAI,KAAK,SAAS;QACnE,MAAM,sHAAA,CAAA,SAAM,CAAC,IAAI,CAAC,MAAM,CAAC;YACvB,OAAO;gBAAE,IAAI,KAAK,EAAE;YAAC;YACrB,MAAM;gBAAE,MAAM;YAAQ;QACxB;QACA,KAAK,IAAI,GAAG;IACd;IAEA,OAAO;AACT;AAEO,eAAe;IACpB,MAAM,OAAO,MAAM;IACnB,IAAI,CAAC,MAAM,MAAM,IAAI,MAAM;IAC3B,OAAO;AACT;AAEO,eAAe;IACpB,MAAM,OAAO,MAAM;IACnB,IAAI,KAAK,IAAI,KAAK,SAAS,MAAM,IAAI,MAAM;IAC3C,OAAO;AACT","debugId":null}},
    {"offset": {"line": 237, "column": 0}, "map": {"version":3,"sources":["file:///Users/ruangalvao/ProjetosVS/Projetos%20Pessoais/stud.ai-app/app-stud.ai/src/app/api/usage/can-process/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { requireUser } from \"@/lib/auth\";\nimport { prisma } from \"@/lib/prisma\";\n\nexport const runtime = \"nodejs\";\n\n// Limite do FREE por mês (mude quando quiser)\nconst FREE_LIMIT_PER_MONTH = 5;\n\nfunction isSameMonth(a: Date, b: Date) {\n  return a.getUTCFullYear() === b.getUTCFullYear() && a.getUTCMonth() === b.getUTCMonth();\n}\n\nfunction isProActive(dbUser: { plan: any; proUntil: Date | null }) {\n  if (dbUser.plan !== \"PRO\") return false;\n  if (!dbUser.proUntil) return false;\n  return dbUser.proUntil.getTime() > Date.now();\n}\n\nexport async function GET() {\n  try {\n    const user = await requireUser();\n\n    const dbUser = await prisma.user.findUnique({\n      where: { id: user.id },\n      select: {\n        id: true,\n        role: true,\n        plan: true,\n        proUntil: true,\n        monthlyUsed: true,\n        monthlyResetAt: true,\n      },\n    });\n\n    if (!dbUser) {\n      return NextResponse.json(\n        { success: false, error: \"Usuário não encontrado.\" },\n        { status: 404 }\n      );\n    }\n\n    const now = new Date();\n\n    // reset mensal se virou o mês\n    if (!isSameMonth(dbUser.monthlyResetAt, now)) {\n      const updated = await prisma.user.update({\n        where: { id: dbUser.id },\n        data: { monthlyUsed: 0, monthlyResetAt: now },\n        select: {\n          role: true,\n          plan: true,\n          proUntil: true,\n          monthlyUsed: true,\n          monthlyResetAt: true,\n        },\n      });\n\n      dbUser.role = updated.role;\n      dbUser.plan = updated.plan;\n      dbUser.proUntil = updated.proUntil;\n      dbUser.monthlyUsed = updated.monthlyUsed;\n      dbUser.monthlyResetAt = updated.monthlyResetAt;\n    }\n\n    const admin = dbUser.role === \"ADMIN\";\n    const proActive = isProActive({ plan: dbUser.plan, proUntil: dbUser.proUntil });\n\n    // Admin e PRO não têm limite\n    if (admin || proActive) {\n      return NextResponse.json({\n        success: true,\n        allowed: true,\n        plan: admin ? \"ADMIN\" : \"PRO\",\n        monthlyUsed: null,\n        limit: null,\n        proUntil: dbUser.proUntil,\n      });\n    }\n\n    // FREE\n    const allowed = dbUser.monthlyUsed < FREE_LIMIT_PER_MONTH;\n\n    return NextResponse.json({\n      success: true,\n      allowed,\n      plan: \"FREE\",\n      monthlyUsed: dbUser.monthlyUsed,\n      limit: FREE_LIMIT_PER_MONTH,\n      proUntil: null,\n    });\n  } catch (e: any) {\n    const msg = e?.message || String(e);\n\n    if (msg === \"UNAUTHORIZED\") {\n      return NextResponse.json(\n        { success: false, error: \"Não autenticado.\" },\n        { status: 401 }\n      );\n    }\n\n    return NextResponse.json(\n      { success: false, error: \"Erro ao checar limite.\", details: msg },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEO,MAAM,UAAU;AAEvB,8CAA8C;AAC9C,MAAM,uBAAuB;AAE7B,SAAS,YAAY,CAAO,EAAE,CAAO;IACnC,OAAO,EAAE,cAAc,OAAO,EAAE,cAAc,MAAM,EAAE,WAAW,OAAO,EAAE,WAAW;AACvF;AAEA,SAAS,YAAY,MAA4C;IAC/D,IAAI,OAAO,IAAI,KAAK,OAAO,OAAO;IAClC,IAAI,CAAC,OAAO,QAAQ,EAAE,OAAO;IAC7B,OAAO,OAAO,QAAQ,CAAC,OAAO,KAAK,KAAK,GAAG;AAC7C;AAEO,eAAe;IACpB,IAAI;QACF,MAAM,OAAO,MAAM,CAAA,GAAA,oHAAA,CAAA,cAAW,AAAD;QAE7B,MAAM,SAAS,MAAM,sHAAA,CAAA,SAAM,CAAC,IAAI,CAAC,UAAU,CAAC;YAC1C,OAAO;gBAAE,IAAI,KAAK,EAAE;YAAC;YACrB,QAAQ;gBACN,IAAI;gBACJ,MAAM;gBACN,MAAM;gBACN,UAAU;gBACV,aAAa;gBACb,gBAAgB;YAClB;QACF;QAEA,IAAI,CAAC,QAAQ;YACX,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;gBAAO,OAAO;YAA0B,GACnD;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,MAAM,IAAI;QAEhB,8BAA8B;QAC9B,IAAI,CAAC,YAAY,OAAO,cAAc,EAAE,MAAM;YAC5C,MAAM,UAAU,MAAM,sHAAA,CAAA,SAAM,CAAC,IAAI,CAAC,MAAM,CAAC;gBACvC,OAAO;oBAAE,IAAI,OAAO,EAAE;gBAAC;gBACvB,MAAM;oBAAE,aAAa;oBAAG,gBAAgB;gBAAI;gBAC5C,QAAQ;oBACN,MAAM;oBACN,MAAM;oBACN,UAAU;oBACV,aAAa;oBACb,gBAAgB;gBAClB;YACF;YAEA,OAAO,IAAI,GAAG,QAAQ,IAAI;YAC1B,OAAO,IAAI,GAAG,QAAQ,IAAI;YAC1B,OAAO,QAAQ,GAAG,QAAQ,QAAQ;YAClC,OAAO,WAAW,GAAG,QAAQ,WAAW;YACxC,OAAO,cAAc,GAAG,QAAQ,cAAc;QAChD;QAEA,MAAM,QAAQ,OAAO,IAAI,KAAK;QAC9B,MAAM,YAAY,YAAY;YAAE,MAAM,OAAO,IAAI;YAAE,UAAU,OAAO,QAAQ;QAAC;QAE7E,6BAA6B;QAC7B,IAAI,SAAS,WAAW;YACtB,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CAAC;gBACvB,SAAS;gBACT,SAAS;gBACT,MAAM,QAAQ,UAAU;gBACxB,aAAa;gBACb,OAAO;gBACP,UAAU,OAAO,QAAQ;YAC3B;QACF;QAEA,OAAO;QACP,MAAM,UAAU,OAAO,WAAW,GAAG;QAErC,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT;YACA,MAAM;YACN,aAAa,OAAO,WAAW;YAC/B,OAAO;YACP,UAAU;QACZ;IACF,EAAE,OAAO,GAAQ;QACf,MAAM,MAAM,GAAG,WAAW,OAAO;QAEjC,IAAI,QAAQ,gBAAgB;YAC1B,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;gBAAO,OAAO;YAAmB,GAC5C;gBAAE,QAAQ;YAAI;QAElB;QAEA,OAAO,gIAAA,CAAA,eAAY,CAAC,IAAI,CACtB;YAAE,SAAS;YAAO,OAAO;YAA0B,SAAS;QAAI,GAChE;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}