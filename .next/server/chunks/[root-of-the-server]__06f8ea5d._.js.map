{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 258, "column": 0}, "map": {"version":3,"sources":["file:///Users/ruangalvao/ProjetosVS/Projetos%20Pessoais/stud.ai-app/app-stud.ai/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\n\ndeclare global {\n  // eslint-disable-next-line no-var\n  var __prisma: PrismaClient | undefined;\n}\n\nfunction createPrismaClient() {\n  const client = new PrismaClient({\n    log: process.env.NODE_ENV === \"development\" ? [\"error\", \"warn\"] : [\"error\"],\n  });\n\n  return client;\n}\n\nexport const prisma = globalThis.__prisma ?? createPrismaClient();\n\nif (process.env.NODE_ENV !== \"production\") {\n  globalThis.__prisma = prisma;\n}\n"],"names":[],"mappings":";;;AAAA;;AAOA,SAAS;IACP,MAAM,SAAS,IAAI,6HAAA,CAAA,eAAY,CAAC;QAC9B,KAAK,uCAAyC;YAAC;YAAS;SAAO,GAAG;IACpE;IAEA,OAAO;AACT;AAEO,MAAM,SAAS,WAAW,QAAQ,IAAI;AAE7C,wCAA2C;IACzC,WAAW,QAAQ,GAAG;AACxB","debugId":null}},
    {"offset": {"line": 280, "column": 0}, "map": {"version":3,"sources":["file:///Users/ruangalvao/ProjetosVS/Projetos%20Pessoais/stud.ai-app/app-stud.ai/src/lib/auth.ts"],"sourcesContent":["import { cookies } from \"next/headers\";\nimport { randomBytes } from \"crypto\";\nimport bcrypt from \"bcryptjs\";\nimport { prisma } from \"@/lib/prisma\";\n\nconst SESSION_COOKIE = \"studai_session\";\nconst SESSION_DAYS = 30;\n\nexport type CurrentUser =\n  | {\n      id: string;\n      email: string;\n      role?: string;\n      name?: string | null;\n    }\n  | null;\n\n/** Emails admin via env (recomendado) */\nexport function isAdminEmail(email: string) {\n  const one = (process.env.ADMIN_EMAIL || \"\").trim().toLowerCase();\n  if (one && email.toLowerCase() === one) return true;\n\n  const many = (process.env.ADMIN_EMAILS || \"\")\n    .split(\",\")\n    .map((s) => s.trim().toLowerCase())\n    .filter(Boolean);\n\n  if (many.length && many.includes(email.toLowerCase())) return true;\n\n  return false;\n}\n\nexport async function hashPassword(password: string) {\n  return bcrypt.hash(password, 10);\n}\n\nexport async function verifyPassword(password: string, passwordHash: string) {\n  return bcrypt.compare(password, passwordHash);\n}\n\n/**\n * Cria sessão no DB e retorna token + expires.\n * (A rota de login deve setar cookie)\n */\nexport async function createSession(userId: string, days: number = SESSION_DAYS) {\n  const sessionToken = randomBytes(32).toString(\"hex\");\n  const expires = new Date(Date.now() + days * 24 * 60 * 60 * 1000);\n\n  await prisma.session.create({\n    data: {\n      userId,\n      sessionToken,\n      expires,\n    },\n  });\n\n  return { sessionToken, expires };\n}\n\n/** Destroi a sessão do token (se existir) */\nexport async function destroySession(sessionToken: string) {\n  try {\n    await prisma.session.delete({ where: { sessionToken } });\n  } catch {\n    // ignore\n  }\n}\n\n/** Seta cookie de sessão (usado por algumas rotas/handlers) */\nexport async function setSessionCookie(params: { token: string; expires: Date }) {\n  const cookieStore = await cookies();\n\n  cookieStore.set(SESSION_COOKIE, params.token, {\n    httpOnly: true,\n    sameSite: \"lax\",\n    secure: process.env.NODE_ENV === \"production\",\n    path: \"/\",\n    expires: params.expires,\n  });\n}\n\n/** Limpa cookie de sessão */\nexport async function clearSessionCookie() {\n  const cookieStore = await cookies();\n  cookieStore.set(SESSION_COOKIE, \"\", {\n    httpOnly: true,\n    sameSite: \"lax\",\n    secure: process.env.NODE_ENV === \"production\",\n    path: \"/\",\n    expires: new Date(0),\n  });\n}\n\n/**\n * ✅ Resiliente: se o DB estiver fora, não quebra o app.\n */\nexport async function getCurrentUser(): Promise<CurrentUser> {\n  try {\n    const cookieStore = await cookies();\n    const token = cookieStore.get(SESSION_COOKIE)?.value;\n    if (!token) return null;\n\n    const session = await prisma.session.findUnique({\n      where: { sessionToken: token },\n      include: { user: true },\n    });\n\n    if (!session) return null;\n\n    if (session.expires && session.expires.getTime() < Date.now()) {\n      return null;\n    }\n\n    if (!session.user) return null;\n\n    return {\n      id: session.user.id,\n      email: session.user.email,\n      role: (session.user as any).role,\n      name: (session.user as any).name ?? null,\n    };\n  } catch {\n    console.warn(\"[auth] DB indisponível, retornando user=null\");\n    return null;\n  }\n}\n\n/**\n * ✅ “Obrigar usuário logado” para rotas protegidas (ex.: upload)\n * Se não estiver logado, lança erro com status 401.\n */\nexport async function requireUser() {\n  const user = await getCurrentUser();\n  if (!user) {\n    const err: any = new Error(\"Não autorizado\");\n    err.status = 401;\n    throw err;\n  }\n  return user;\n}\n"],"names":[],"mappings":";;;;;;;;;;;AAAA;AACA;AACA;AACA;;;;;AAEA,MAAM,iBAAiB;AACvB,MAAM,eAAe;AAYd,SAAS,aAAa,KAAa;IACxC,MAAM,MAAM,CAAC,QAAQ,GAAG,CAAC,WAAW,IAAI,EAAE,EAAE,IAAI,GAAG,WAAW;IAC9D,IAAI,OAAO,MAAM,WAAW,OAAO,KAAK,OAAO;IAE/C,MAAM,OAAO,CAAC,QAAQ,GAAG,CAAC,YAAY,IAAI,EAAE,EACzC,KAAK,CAAC,KACN,GAAG,CAAC,CAAC,IAAM,EAAE,IAAI,GAAG,WAAW,IAC/B,MAAM,CAAC;IAEV,IAAI,KAAK,MAAM,IAAI,KAAK,QAAQ,CAAC,MAAM,WAAW,KAAK,OAAO;IAE9D,OAAO;AACT;AAEO,eAAe,aAAa,QAAgB;IACjD,OAAO,mIAAA,CAAA,UAAM,CAAC,IAAI,CAAC,UAAU;AAC/B;AAEO,eAAe,eAAe,QAAgB,EAAE,YAAoB;IACzE,OAAO,mIAAA,CAAA,UAAM,CAAC,OAAO,CAAC,UAAU;AAClC;AAMO,eAAe,cAAc,MAAc,EAAE,OAAe,YAAY;IAC7E,MAAM,eAAe,CAAA,GAAA,qGAAA,CAAA,cAAW,AAAD,EAAE,IAAI,QAAQ,CAAC;IAC9C,MAAM,UAAU,IAAI,KAAK,KAAK,GAAG,KAAK,OAAO,KAAK,KAAK,KAAK;IAE5D,MAAM,sHAAA,CAAA,SAAM,CAAC,OAAO,CAAC,MAAM,CAAC;QAC1B,MAAM;YACJ;YACA;YACA;QACF;IACF;IAEA,OAAO;QAAE;QAAc;IAAQ;AACjC;AAGO,eAAe,eAAe,YAAoB;IACvD,IAAI;QACF,MAAM,sHAAA,CAAA,SAAM,CAAC,OAAO,CAAC,MAAM,CAAC;YAAE,OAAO;gBAAE;YAAa;QAAE;IACxD,EAAE,OAAM;IACN,SAAS;IACX;AACF;AAGO,eAAe,iBAAiB,MAAwC;IAC7E,MAAM,cAAc,MAAM,CAAA,GAAA,iIAAA,CAAA,UAAO,AAAD;IAEhC,YAAY,GAAG,CAAC,gBAAgB,OAAO,KAAK,EAAE;QAC5C,UAAU;QACV,UAAU;QACV,QAAQ,oDAAyB;QACjC,MAAM;QACN,SAAS,OAAO,OAAO;IACzB;AACF;AAGO,eAAe;IACpB,MAAM,cAAc,MAAM,CAAA,GAAA,iIAAA,CAAA,UAAO,AAAD;IAChC,YAAY,GAAG,CAAC,gBAAgB,IAAI;QAClC,UAAU;QACV,UAAU;QACV,QAAQ,oDAAyB;QACjC,MAAM;QACN,SAAS,IAAI,KAAK;IACpB;AACF;AAKO,eAAe;IACpB,IAAI;QACF,MAAM,cAAc,MAAM,CAAA,GAAA,iIAAA,CAAA,UAAO,AAAD;QAChC,MAAM,QAAQ,YAAY,GAAG,CAAC,iBAAiB;QAC/C,IAAI,CAAC,OAAO,OAAO;QAEnB,MAAM,UAAU,MAAM,sHAAA,CAAA,SAAM,CAAC,OAAO,CAAC,UAAU,CAAC;YAC9C,OAAO;gBAAE,cAAc;YAAM;YAC7B,SAAS;gBAAE,MAAM;YAAK;QACxB;QAEA,IAAI,CAAC,SAAS,OAAO;QAErB,IAAI,QAAQ,OAAO,IAAI,QAAQ,OAAO,CAAC,OAAO,KAAK,KAAK,GAAG,IAAI;YAC7D,OAAO;QACT;QAEA,IAAI,CAAC,QAAQ,IAAI,EAAE,OAAO;QAE1B,OAAO;YACL,IAAI,QAAQ,IAAI,CAAC,EAAE;YACnB,OAAO,QAAQ,IAAI,CAAC,KAAK;YACzB,MAAM,AAAC,QAAQ,IAAI,CAAS,IAAI;YAChC,MAAM,AAAC,QAAQ,IAAI,CAAS,IAAI,IAAI;QACtC;IACF,EAAE,OAAM;QACN,QAAQ,IAAI,CAAC;QACb,OAAO;IACT;AACF;AAMO,eAAe;IACpB,MAAM,OAAO,MAAM;IACnB,IAAI,CAAC,MAAM;QACT,MAAM,MAAW,IAAI,MAAM;QAC3B,IAAI,MAAM,GAAG;QACb,MAAM;IACR;IACA,OAAO;AACT","debugId":null}},
    {"offset": {"line": 402, "column": 0}, "map": {"version":3,"sources":["file:///Users/ruangalvao/ProjetosVS/Projetos%20Pessoais/stud.ai-app/app-stud.ai/src/app/api/process-study-material/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport OpenAI from \"openai\";\nimport {\n  GoogleGenAI,\n  createPartFromUri,\n  createUserContent,\n} from \"@google/genai\";\nimport { prisma } from \"@/lib/prisma\";\nimport { requireUser } from \"@/lib/auth\";\nimport crypto from \"crypto\";\nimport os from \"os\";\nimport path from \"path\";\nimport { writeFile, unlink } from \"fs/promises\";\nimport * as pdfParse from \"pdf-parse\";\n\nexport const runtime = \"nodejs\";\nexport const dynamic = \"force-dynamic\";\n\ntype Provider = \"openai\" | \"gemini\";\ntype SummaryStyle = \"bullet\" | \"explained\";\ntype CardDifficulty = \"easy\" | \"medium\" | \"hard\";\n\nconst FREE_MONTHLY_LIMIT = Number(process.env.FREE_MONTHLY_LIMIT || \"10\");\n\n// ---------- helpers ----------\nfunction hasValue(v?: string) {\n  return typeof v === \"string\" && v.trim().length > 0;\n}\n\nfunction sleep(ms: number) {\n  return new Promise((r) => setTimeout(r, ms));\n}\n\nfunction monthKey(d = new Date()) {\n  const y = d.getFullYear();\n  const m = String(d.getMonth() + 1).padStart(2, \"0\");\n  return `${y}-${m}`;\n}\n\nfunction isProActive(user: any) {\n  if (user?.role === \"ADMIN\") return true;\n  if (user?.plan === \"PRO\") {\n    if (!user?.proUntil) return true;\n    return new Date(user.proUntil).getTime() > Date.now();\n  }\n  return false;\n}\n\nfunction getGeminiKey() {\n  return process.env.GEMINI_API_KEY || process.env.GOOGLE_API_KEY || \"\";\n}\n\nfunction safeParseJson(raw: string) {\n  try {\n    return JSON.parse(raw);\n  } catch {\n    return null;\n  }\n}\n\nfunction getStudySchema() {\n  return {\n    type: \"object\",\n    additionalProperties: false,\n    required: [\"topic\", \"flashcards\", \"summary\"],\n    properties: {\n      topic: { type: \"string\" },\n      flashcards: {\n        type: \"array\",\n        items: {\n          type: \"object\",\n          additionalProperties: false,\n          required: [\"id\", \"question\", \"answer\"],\n          properties: {\n            id: { type: \"integer\" },\n            question: { type: \"string\" },\n            answer: { type: \"string\" },\n          },\n        },\n      },\n      summary: {\n        type: \"object\",\n        additionalProperties: false,\n        required: [\"title\", \"style\", \"difficulty\", \"mainTopics\", \"keyPoints\"],\n        properties: {\n          title: { type: \"string\" },\n          style: { type: \"string\" },\n          difficulty: { type: \"string\" },\n          mainTopics: {\n            type: \"array\",\n            items: {\n              type: \"object\",\n              additionalProperties: false,\n              required: [\"id\", \"title\", \"content\", \"icon\"],\n              properties: {\n                id: { type: \"integer\" },\n                title: { type: \"string\" },\n                content: { type: \"string\" },\n                icon: { type: \"string\" },\n              },\n            },\n          },\n          keyPoints: { type: \"array\", items: { type: \"string\" } },\n        },\n      },\n    },\n  };\n}\n\nfunction buildPromptFromText(params: {\n  text: string;\n  flashcardsCount: number;\n  summaryStyle: SummaryStyle;\n  difficulty: CardDifficulty;\n}) {\n  const styleText =\n    params.summaryStyle === \"bullet\"\n      ? \"Resuma em formato de tópicos (bullet points), direto e objetivo.\"\n      : \"Resuma explicado, em texto corrido e bem didático, com exemplos quando fizer sentido.\";\n\n  const diffText =\n    params.difficulty === \"easy\"\n      ? \"Flashcards fáceis (definições e perguntas diretas).\"\n      : params.difficulty === \"hard\"\n      ? \"Flashcards difíceis (perguntas que exigem raciocínio, aplicação e comparação).\"\n      : \"Flashcards de dificuldade média (conceitos + aplicação simples).\";\n\n  const baseJson = `Retorne APENAS um JSON válido com esta estrutura:\n{\n  \"topic\": \"Tópico principal do material\",\n  \"flashcards\": [\n    { \"id\": 1, \"question\": \"Pergunta clara e objetiva\", \"answer\": \"Resposta completa e educativa\" }\n  ],\n  \"summary\": {\n    \"title\": \"Título do resumo\",\n    \"style\": \"${params.summaryStyle}\",\n    \"difficulty\": \"${params.difficulty}\",\n    \"mainTopics\": [\n      { \"id\": 1, \"title\": \"Título do tópico\", \"content\": \"Conteúdo detalhado do tópico\", \"icon\": \"emoji apropriado\" }\n    ],\n    \"keyPoints\": [\"ponto-chave 1\", \"ponto-chave 2\"]\n  }\n}`;\n\n  const rules = `Regras:\n- Crie exatamente ${params.flashcardsCount} flashcards.\n- ${diffText}\n- ${styleText}\n- Crie 3 a 5 tópicos principais em summary.mainTopics.\n- Seja educativo e completo.\n- Não inclua texto fora do JSON.`;\n\n  const snippet = params.text.slice(0, 12000);\n\n  return `Analise este conteúdo de estudo e crie material educacional:\n\n${snippet}\n\n${baseJson}\n\n${rules}`;\n}\n\nfunction buildPromptForPdfOcr(params: {\n  flashcardsCount: number;\n  summaryStyle: SummaryStyle;\n  difficulty: CardDifficulty;\n}) {\n  // Importante: aqui o conteúdo vem do ARQUIVO PDF anexado (via URI).\n  // Então o prompt não precisa colar o texto; precisa instruir a extrair/OCR.\n  const styleText =\n    params.summaryStyle === \"bullet\"\n      ? \"Resuma em formato de tópicos (bullet points), direto e objetivo.\"\n      : \"Resuma explicado, em texto corrido e bem didático, com exemplos quando fizer sentido.\";\n\n  const diffText =\n    params.difficulty === \"easy\"\n      ? \"Flashcards fáceis (definições e perguntas diretas).\"\n      : params.difficulty === \"hard\"\n      ? \"Flashcards difíceis (perguntas que exigem raciocínio, aplicação e comparação).\"\n      : \"Flashcards de dificuldade média (conceitos + aplicação simples).\";\n\n  const baseJson = `Retorne APENAS um JSON válido com esta estrutura:\n{\n  \"topic\": \"Tópico principal do material\",\n  \"flashcards\": [\n    { \"id\": 1, \"question\": \"Pergunta clara e objetiva\", \"answer\": \"Resposta completa e educativa\" }\n  ],\n  \"summary\": {\n    \"title\": \"Título do resumo\",\n    \"style\": \"${params.summaryStyle}\",\n    \"difficulty\": \"${params.difficulty}\",\n    \"mainTopics\": [\n      { \"id\": 1, \"title\": \"Título do tópico\", \"content\": \"Conteúdo detalhado do tópico\", \"icon\": \"emoji apropriado\" }\n    ],\n    \"keyPoints\": [\"ponto-chave 1\", \"ponto-chave 2\"]\n  }\n}`;\n\n  const rules = `Regras:\n- O conteúdo está em um ARQUIVO PDF anexado. Extraia o texto do PDF.\n- Se o PDF for escaneado/imagem, faça OCR e recupere o máximo de texto possível.\n- Crie exatamente ${params.flashcardsCount} flashcards.\n- ${diffText}\n- ${styleText}\n- Crie 3 a 5 tópicos principais em summary.mainTopics.\n- Seja educativo e completo.\n- Não inclua texto fora do JSON.`;\n\n  return `Você é um assistente educacional. Use o PDF anexado como fonte.\n\n${baseJson}\n\n${rules}`;\n}\n\n// ---------- PDF text extraction ----------\nasync function extractPdfText(buffer: Buffer) {\n  try {\n    const data = await (pdfParse as any)(buffer);\n    const text = (data?.text || \"\").replace(/\\s+\\n/g, \"\\n\").trim();\n    return text;\n  } catch {\n    return \"\";\n  }\n}\n\nfunction looksLikeHasRealText(text: string) {\n  // heurística simples: texto suficiente e com “densidade” mínima\n  const t = (text || \"\").trim();\n  if (t.length < 300) return false;\n  // se quase tudo for caracteres estranhos, também não\n  const weird = t.match(/[^\\p{L}\\p{N}\\p{P}\\p{Z}\\n\\r]/gu)?.length ?? 0;\n  const ratio = weird / Math.max(1, t.length);\n  return ratio < 0.05;\n}\n\n// ---------- quota control ----------\nasync function enforceAndIncrementUsage(userId: string) {\n  const now = new Date();\n  const mk = monthKey(now);\n\n  const user = await prisma.user.findUnique({ where: { id: userId } });\n  if (!user)\n    throw Object.assign(new Error(\"Usuário não encontrado.\"), { status: 401 });\n\n  if (isProActive(user)) {\n    return { ok: true, user, limited: false, remaining: null };\n  }\n\n  const last = user.monthlyResetAt ? monthKey(user.monthlyResetAt) : null;\n  if (last !== mk) {\n    await prisma.user.update({\n      where: { id: userId },\n      data: { monthlyUsed: 0, monthlyResetAt: now },\n    });\n    (user as any).monthlyUsed = 0;\n    (user as any).monthlyResetAt = now;\n  }\n\n  if ((user.monthlyUsed ?? 0) >= FREE_MONTHLY_LIMIT) {\n    return { ok: false, user, limited: true, remaining: 0 };\n  }\n\n  const updated = await prisma.user.update({\n    where: { id: userId },\n    data: { monthlyUsed: { increment: 1 } },\n  });\n\n  const remaining = Math.max(0, FREE_MONTHLY_LIMIT - (updated.monthlyUsed ?? 0));\n  return { ok: true, user: updated, limited: true, remaining };\n}\n\n// ---------- providers ----------\nasync function runWithOpenAI(params: { content: any[]; model: string }) {\n  const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });\n\n  const completion = await openai.chat.completions.create({\n    model: params.model,\n    messages: [\n      {\n        role: \"system\",\n        content:\n          \"Você é um assistente educacional especializado em criar materiais de estudo. Responda sempre com JSON válido e nada além disso.\",\n      },\n      { role: \"user\", content: params.content },\n    ],\n    response_format: { type: \"json_object\" },\n    max_tokens: 2000,\n  });\n\n  const raw = completion.choices[0]?.message?.content || \"\";\n  const parsed = safeParseJson(raw);\n  if (!parsed) throw new Error(\"OpenAI retornou JSON inválido.\");\n  return parsed;\n}\n\nasync function runWithGeminiText(params: { prompt: string; model: string; retries?: number }) {\n  const ai = new GoogleGenAI({ apiKey: getGeminiKey() });\n  const retries = params.retries ?? 2;\n\n  for (let attempt = 0; attempt <= retries; attempt++) {\n    try {\n      const response = await ai.models.generateContent({\n        model: params.model,\n        contents: params.prompt,\n        config: {\n          systemInstruction:\n            \"Você é um assistente educacional especializado em criar materiais de estudo. Responda apenas em JSON seguindo o schema.\",\n          responseMimeType: \"application/json\",\n          responseJsonSchema: getStudySchema(),\n        },\n      });\n\n      const raw = response.text || \"\";\n      const parsed = safeParseJson(raw);\n      if (!parsed) throw new Error(\"Gemini retornou JSON inválido.\");\n      return parsed;\n    } catch (err: any) {\n      const status = err?.status || err?.code;\n      const msg = (err?.message || \"\").toString();\n      const overloaded =\n        status === 503 || msg.includes(\"overloaded\") || msg.includes(\"UNAVAILABLE\");\n\n      if (attempt < retries && overloaded) {\n        await sleep(1000 * (attempt + 1) * (attempt + 1));\n        continue;\n      }\n      throw err;\n    }\n  }\n\n  throw new Error(\"Falha ao gerar com Gemini.\");\n}\n\nasync function uploadBufferToTmpFile(buffer: Buffer, ext: string) {\n  const name = `studai-${Date.now()}-${crypto.randomBytes(6).toString(\"hex\")}${ext}`;\n  const tmpPath = path.join(os.tmpdir(), name);\n  await writeFile(tmpPath, buffer);\n  return tmpPath;\n}\n\nasync function runWithGeminiPdf(params: {\n  pdfBuffer: Buffer;\n  prompt: string;\n  model: string;\n  retries?: number;\n}) {\n  const apiKey = getGeminiKey();\n  if (!apiKey) {\n    throw Object.assign(\n      new Error(\"GEMINI_API_KEY não configurada (necessária para OCR em PDF escaneado).\"),\n      { status: 500 }\n    );\n  }\n\n  const ai = new GoogleGenAI({ apiKey });\n  const retries = params.retries ?? 1;\n\n  for (let attempt = 0; attempt <= retries; attempt++) {\n    let tmpPath: string | null = null;\n\n    try {\n      tmpPath = await uploadBufferToTmpFile(params.pdfBuffer, \".pdf\");\n\n      // Upload de PDF (suporta PDF e OCR quando necessário) :contentReference[oaicite:1]{index=1}\n      const myfile = await ai.files.upload({\n        file: tmpPath,\n        config: { mimeType: \"application/pdf\" },\n      });\n\n      const response = await ai.models.generateContent({\n        model: params.model,\n        contents: createUserContent([\n          createPartFromUri(myfile.uri, myfile.mimeType),\n          \"\\n\\n\",\n          params.prompt,\n        ]),\n        config: {\n          systemInstruction:\n            \"Você é um assistente educacional especializado em criar materiais de estudo. Responda apenas em JSON seguindo o schema.\",\n          responseMimeType: \"application/json\",\n          responseJsonSchema: getStudySchema(),\n        },\n      });\n\n      const raw = response.text || \"\";\n      const parsed = safeParseJson(raw);\n      if (!parsed) throw new Error(\"Gemini retornou JSON inválido.\");\n      return parsed;\n    } catch (err: any) {\n      const status = err?.status || err?.code;\n      const msg = (err?.message || \"\").toString();\n      const overloaded =\n        status === 503 || msg.includes(\"overloaded\") || msg.includes(\"UNAVAILABLE\");\n\n      if (attempt < retries && overloaded) {\n        await sleep(1000 * (attempt + 1) * (attempt + 1));\n        continue;\n      }\n      throw err;\n    } finally {\n      if (tmpPath) {\n        await unlink(tmpPath).catch(() => {});\n      }\n    }\n  }\n\n  throw new Error(\"Falha ao gerar com Gemini a partir do PDF.\");\n}\n\nfunction isRetryableAIError(err: any) {\n  const status = err?.status || err?.code;\n  const msg = (err?.message || \"\").toString();\n\n  if (status === 429) return true; // rate/quota\n  if (status === 503) return true; // overloaded\n  if (msg.includes(\"overloaded\") || msg.includes(\"UNAVAILABLE\")) return true;\n  if (msg.includes(\"insufficient_quota\")) return true;\n  if (msg.includes(\"quota\")) return true;\n  if (msg.includes(\"rate\")) return true;\n\n  return false;\n}\n\nfunction pickProviderOrder(): Provider[] {\n  const forced = (process.env.AI_PROVIDER || \"auto\").toLowerCase();\n\n  const hasOpenAI = hasValue(process.env.OPENAI_API_KEY);\n  const hasGemini = hasValue(process.env.GEMINI_API_KEY) || hasValue(process.env.GOOGLE_API_KEY);\n\n  if (forced === \"gemini\") {\n    if (!hasGemini)\n      throw Object.assign(new Error(\"GEMINI_API_KEY não configurada.\"), { status: 500 });\n    return hasOpenAI ? [\"gemini\", \"openai\"] : [\"gemini\"];\n  }\n\n  if (forced === \"openai\") {\n    if (!hasOpenAI)\n      throw Object.assign(new Error(\"OPENAI_API_KEY não configurada.\"), { status: 500 });\n    return hasGemini ? [\"openai\", \"gemini\"] : [\"openai\"];\n  }\n\n  // auto: Gemini primeiro (evita 429 OpenAI)\n  if (hasGemini && hasOpenAI) return [\"gemini\", \"openai\"];\n  if (hasGemini) return [\"gemini\"];\n  if (hasOpenAI) return [\"openai\"];\n\n  throw Object.assign(new Error(\"Nenhuma chave de IA encontrada.\"), { status: 500 });\n}\n\n// ---------- main ----------\nexport async function POST(request: NextRequest) {\n  try {\n    const current = await requireUser();\n\n    const quota = await enforceAndIncrementUsage(current.id);\n    if (!quota.ok) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: \"Limite do plano grátis atingido.\",\n          code: \"FREE_LIMIT_REACHED\",\n          limit: FREE_MONTHLY_LIMIT,\n          remaining: 0,\n        },\n        { status: 402 }\n      );\n    }\n\n    const formData = await request.formData();\n    const file = formData.get(\"file\") as File | null;\n\n    const flashcardsCount = Math.min(\n      50,\n      Math.max(1, Number(formData.get(\"flashcardsCount\") || 10))\n    );\n    const summaryStyle = (formData.get(\"summaryStyle\") || \"bullet\") as SummaryStyle;\n    const difficulty = (formData.get(\"difficulty\") || \"medium\") as CardDifficulty;\n\n    if (!file) {\n      return NextResponse.json(\n        { success: false, error: \"Nenhum arquivo foi enviado\" },\n        { status: 400 }\n      );\n    }\n\n    const bytes = await file.arrayBuffer();\n    const buffer = Buffer.from(bytes);\n\n    const mimeType = file.type || \"application/octet-stream\";\n    const isPdf =\n      mimeType === \"application/pdf\" || file.name.toLowerCase().endsWith(\".pdf\");\n    const isImage = mimeType.startsWith(\"image/\");\n\n    // evita uploads gigantes (especialmente PDF escaneado)\n    const MAX_BYTES = 20 * 1024 * 1024; // 20MB\n    if (buffer.length > MAX_BYTES) {\n      return NextResponse.json(\n        { success: false, error: \"Arquivo muito grande (máx. 20MB).\" },\n        { status: 413 }\n      );\n    }\n\n    const openaiModel = process.env.OPENAI_MODEL || \"gpt-4o-mini\";\n    const geminiModel = process.env.GEMINI_MODEL || \"gemini-2.0-flash\";\n    const order = pickProviderOrder();\n\n    let parsedResult: any = null;\n    let used: Provider | null = null;\n    let lastErr: any = null;\n\n    // ---------- PDF path ----------\n    if (isPdf) {\n      // 1) tenta extrair texto real\n      const extracted = await extractPdfText(buffer);\n\n      if (looksLikeHasRealText(extracted)) {\n        // PDF com texto: manda o texto pro modelo (sem binário!)\n        const prompt = buildPromptFromText({\n          text: extracted,\n          flashcardsCount,\n          summaryStyle,\n          difficulty,\n        });\n\n        for (const provider of order) {\n          try {\n            if (provider === \"gemini\") {\n              parsedResult = await runWithGeminiText({\n                prompt,\n                model: geminiModel,\n                retries: 2,\n              });\n              used = \"gemini\";\n            } else {\n              parsedResult = await runWithOpenAI({\n                content: [{ type: \"text\", text: prompt }],\n                model: openaiModel,\n              });\n              used = \"openai\";\n            }\n            break;\n          } catch (err: any) {\n            lastErr = err;\n            if (isRetryableAIError(err)) continue;\n            throw err;\n          }\n        }\n      } else {\n        // 2) PDF sem texto (escaneado): OCR via Gemini (upload do PDF)\n        const prompt = buildPromptForPdfOcr({\n          flashcardsCount,\n          summaryStyle,\n          difficulty,\n        });\n\n        try {\n          parsedResult = await runWithGeminiPdf({\n            pdfBuffer: buffer,\n            prompt,\n            model: geminiModel,\n            retries: 1,\n          });\n          used = \"gemini\";\n        } catch (err: any) {\n          lastErr = err;\n          const msg = (err?.message || \"\").toString();\n          return NextResponse.json(\n            {\n              success: false,\n              error:\n                \"Não foi possível ler este PDF (possivelmente escaneado) agora. Verifique GEMINI_API_KEY e tente novamente.\",\n              details: msg,\n              code: \"PDF_OCR_FAILED\",\n            },\n            { status: 503 }\n          );\n        }\n      }\n    }\n\n    // ---------- IMAGE path ----------\n    if (!parsedResult && isImage) {\n      const base64 = buffer.toString(\"base64\");\n\n      // (para imagem, Gemini geralmente é melhor/mais barato no seu caso)\n      const prompt = buildPromptForPdfOcr({\n        flashcardsCount,\n        summaryStyle,\n        difficulty,\n      }).replace(\n        \"Use o PDF anexado como fonte.\",\n        \"Use a IMAGEM anexada como fonte.\"\n      );\n\n      for (const provider of order) {\n        try {\n          if (provider === \"gemini\") {\n            const ai = new GoogleGenAI({ apiKey: getGeminiKey() });\n            const response = await ai.models.generateContent({\n              model: geminiModel,\n              contents: [\n                { inlineData: { mimeType, data: base64 } },\n                { text: prompt },\n              ],\n              config: {\n                systemInstruction:\n                  \"Você é um assistente educacional especializado em criar materiais de estudo. Responda apenas em JSON seguindo o schema.\",\n                responseMimeType: \"application/json\",\n                responseJsonSchema: getStudySchema(),\n              },\n            });\n\n            const raw = response.text || \"\";\n            const parsed = safeParseJson(raw);\n            if (!parsed) throw new Error(\"Gemini retornou JSON inválido.\");\n            parsedResult = parsed;\n            used = \"gemini\";\n          } else {\n            const content = [\n              { type: \"text\", text: prompt },\n              { type: \"image_url\", image_url: { url: `data:${mimeType};base64,${base64}` } },\n            ];\n            parsedResult = await runWithOpenAI({ content, model: openaiModel });\n            used = \"openai\";\n          }\n          break;\n        } catch (err: any) {\n          lastErr = err;\n          if (isRetryableAIError(err)) continue;\n          throw err;\n        }\n      }\n    }\n\n    // ---------- TEXT (non-pdf, non-image) path ----------\n    if (!parsedResult && !isImage && !isPdf) {\n      // aqui só vale se for um arquivo textual (txt/md/etc).\n      // NÃO converta binário pra utf-8.\n      const text = buffer.toString(\"utf-8\").trim();\n\n      if (!text || text.length < 50) {\n        return NextResponse.json(\n          {\n            success: false,\n            error:\n              \"Não foi possível extrair texto deste arquivo. Envie um PDF, imagem, ou texto (txt/md).\",\n          },\n          { status: 400 }\n        );\n      }\n\n      const prompt = buildPromptFromText({\n        text,\n        flashcardsCount,\n        summaryStyle,\n        difficulty,\n      });\n\n      for (const provider of order) {\n        try {\n          if (provider === \"gemini\") {\n            parsedResult = await runWithGeminiText({\n              prompt,\n              model: geminiModel,\n              retries: 2,\n            });\n            used = \"gemini\";\n          } else {\n            parsedResult = await runWithOpenAI({\n              content: [{ type: \"text\", text: prompt }],\n              model: openaiModel,\n            });\n            used = \"openai\";\n          }\n          break;\n        } catch (err: any) {\n          lastErr = err;\n          if (isRetryableAIError(err)) continue;\n          throw err;\n        }\n      }\n    }\n\n    // ---------- post-check ----------\n    if (!parsedResult) {\n      const msg = (lastErr?.message || \"\").toString();\n      return NextResponse.json(\n        { success: false, error: \"Falha ao gerar com IA.\", details: msg },\n        { status: 503 }\n      );\n    }\n\n    if (!parsedResult?.topic || !parsedResult?.flashcards || !parsedResult?.summary) {\n      return NextResponse.json(\n        {\n          success: false,\n          error: \"Resposta inválida do modelo (faltou topic/flashcards/summary).\",\n          code: \"INVALID_AI_RESPONSE\",\n          raw: parsedResult,\n        },\n        { status: 502 }\n      );\n    }\n\n    await prisma.studyMaterial.create({\n      data: {\n        userId: current.id,\n        topic: String(parsedResult.topic || \"Material\"),\n        originalFilename: file.name,\n        mimeType,\n        data: parsedResult,\n      },\n    });\n\n    return NextResponse.json({\n      success: true,\n      provider: used,\n      remaining: quota.limited && typeof quota.remaining === \"number\" ? quota.remaining : null,\n      data: parsedResult,\n    });\n  } catch (error: any) {\n    const status = error?.status || 500;\n    const msg = (error?.message || \"\").toString();\n\n    if (status === 401) {\n      return NextResponse.json(\n        { success: false, error: \"Não autorizado.\" },\n        { status: 401 }\n      );\n    }\n\n    console.error(\"Erro ao processar arquivo:\", error);\n    return NextResponse.json(\n      { success: false, error: \"Erro ao processar o arquivo\", details: msg },\n      { status: status >= 400 && status <= 599 ? status : 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}