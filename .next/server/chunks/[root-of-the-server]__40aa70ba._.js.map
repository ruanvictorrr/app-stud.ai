{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 74, "column": 0}, "map": {"version":3,"sources":["file:///Users/ruangalvao/ProjetosVS/Projetos%20Pessoais/stud.ai-app/app-stud.ai/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\n\ndeclare global {\n  // eslint-disable-next-line no-var\n  var __prisma: PrismaClient | undefined;\n}\n\nfunction createPrismaClient() {\n  const client = new PrismaClient({\n    log: process.env.NODE_ENV === \"development\" ? [\"error\", \"warn\"] : [\"error\"],\n  });\n\n  return client;\n}\n\nexport const prisma = globalThis.__prisma ?? createPrismaClient();\n\nif (process.env.NODE_ENV !== \"production\") {\n  globalThis.__prisma = prisma;\n}\n"],"names":[],"mappings":";;;AAAA;;AAOA,SAAS;IACP,MAAM,SAAS,IAAI,6HAAA,CAAA,eAAY,CAAC;QAC9B,KAAK,uCAAyC;YAAC;YAAS;SAAO,GAAG;IACpE;IAEA,OAAO;AACT;AAEO,MAAM,SAAS,WAAW,QAAQ,IAAI;AAE7C,wCAA2C;IACzC,WAAW,QAAQ,GAAG;AACxB","debugId":null}},
    {"offset": {"line": 104, "column": 0}, "map": {"version":3,"sources":["file:///Users/ruangalvao/ProjetosVS/Projetos%20Pessoais/stud.ai-app/app-stud.ai/src/lib/auth.ts"],"sourcesContent":["import { cookies } from \"next/headers\";\nimport { randomBytes } from \"crypto\";\nimport bcrypt from \"bcryptjs\";\nimport { prisma } from \"@/lib/prisma\";\n\nconst SESSION_COOKIE = \"studai_session\";\nconst SESSION_DAYS = 30;\n\nexport type CurrentUser =\n  | {\n      id: string;\n      email: string;\n      role?: string;\n      name?: string | null;\n    }\n  | null;\n\n/** Emails admin via env (recomendado) */\nexport function isAdminEmail(email: string) {\n  const one = (process.env.ADMIN_EMAIL || \"\").trim().toLowerCase();\n  if (one && email.toLowerCase() === one) return true;\n\n  const many = (process.env.ADMIN_EMAILS || \"\")\n    .split(\",\")\n    .map((s) => s.trim().toLowerCase())\n    .filter(Boolean);\n\n  if (many.length && many.includes(email.toLowerCase())) return true;\n\n  return false;\n}\n\nexport async function hashPassword(password: string) {\n  return bcrypt.hash(password, 10);\n}\n\nexport async function verifyPassword(password: string, passwordHash: string) {\n  return bcrypt.compare(password, passwordHash);\n}\n\n/**\n * Cria sessão no DB e retorna token + expires.\n * (A rota de login deve setar cookie)\n */\nexport async function createSession(userId: string, days: number = SESSION_DAYS) {\n  const sessionToken = randomBytes(32).toString(\"hex\");\n  const expires = new Date(Date.now() + days * 24 * 60 * 60 * 1000);\n\n  await prisma.session.create({\n    data: {\n      userId,\n      sessionToken,\n      expires,\n    },\n  });\n\n  return { sessionToken, expires };\n}\n\n/** Destroi a sessão do token (se existir) */\nexport async function destroySession(sessionToken: string) {\n  try {\n    await prisma.session.delete({ where: { sessionToken } });\n  } catch {\n    // ignore\n  }\n}\n\n/** Seta cookie de sessão (usado por algumas rotas/handlers) */\nexport async function setSessionCookie(params: { token: string; expires: Date }) {\n  const cookieStore = await cookies();\n\n  cookieStore.set(SESSION_COOKIE, params.token, {\n    httpOnly: true,\n    sameSite: \"lax\",\n    secure: process.env.NODE_ENV === \"production\",\n    path: \"/\",\n    expires: params.expires,\n  });\n}\n\n/** Limpa cookie de sessão */\nexport async function clearSessionCookie() {\n  const cookieStore = await cookies();\n  cookieStore.set(SESSION_COOKIE, \"\", {\n    httpOnly: true,\n    sameSite: \"lax\",\n    secure: process.env.NODE_ENV === \"production\",\n    path: \"/\",\n    expires: new Date(0),\n  });\n}\n\n/**\n * ✅ Resiliente: se o DB estiver fora, não quebra o app.\n */\nexport async function getCurrentUser(): Promise<CurrentUser> {\n  try {\n    const cookieStore = await cookies();\n    const token = cookieStore.get(SESSION_COOKIE)?.value;\n    if (!token) return null;\n\n    const session = await prisma.session.findUnique({\n      where: { sessionToken: token },\n      include: { user: true },\n    });\n\n    if (!session) return null;\n\n    if (session.expires && session.expires.getTime() < Date.now()) {\n      return null;\n    }\n\n    if (!session.user) return null;\n\n    return {\n      id: session.user.id,\n      email: session.user.email,\n      role: (session.user as any).role,\n      name: (session.user as any).name ?? null,\n    };\n  } catch {\n    console.warn(\"[auth] DB indisponível, retornando user=null\");\n    return null;\n  }\n}\n\n/**\n * ✅ “Obrigar usuário logado” para rotas protegidas (ex.: upload)\n * Se não estiver logado, lança erro com status 401.\n */\nexport async function requireUser() {\n  const user = await getCurrentUser();\n  if (!user) {\n    const err: any = new Error(\"Não autorizado\");\n    err.status = 401;\n    throw err;\n  }\n  return user;\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 226, "column": 0}, "map": {"version":3,"sources":["file:///Users/ruangalvao/ProjetosVS/Projetos%20Pessoais/stud.ai-app/app-stud.ai/src/app/api/auth/login/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { prisma } from \"@/lib/prisma\";\nimport { createSession, verifyPassword, isAdminEmail } from \"@/lib/auth\";\n\nexport const runtime = \"nodejs\";\n\nexport async function POST(req: NextRequest) {\n  try {\n    const body = await req.json().catch(() => null);\n\n    const email = (body?.email || body?.username || \"\").toString().trim().toLowerCase();\n    const password = (body?.password || \"\").toString();\n\n    if (!email || !password) {\n      return NextResponse.json(\n        { success: false, error: \"Email e senha são obrigatórios.\" },\n        { status: 400 }\n      );\n    }\n\n    // ✅ tenta buscar usuário\n    let user: any = null;\n    try {\n      user = await prisma.user.findUnique({ where: { email } });\n    } catch (dbErr: any) {\n      console.error(\"LOGIN_DB_FIND_ERROR:\", dbErr);\n      return NextResponse.json(\n        {\n          success: false,\n          error: \"Banco de dados indisponível no momento. Tente novamente.\",\n          details: dbErr?.message || String(dbErr),\n        },\n        { status: 503 }\n      );\n    }\n\n    if (!user || !user.passwordHash) {\n      return NextResponse.json(\n        { success: false, error: \"Credenciais inválidas.\" },\n        { status: 401 }\n      );\n    }\n\n    const ok = await verifyPassword(password, user.passwordHash);\n    if (!ok) {\n      return NextResponse.json(\n        { success: false, error: \"Credenciais inválidas.\" },\n        { status: 401 }\n      );\n    }\n\n    // garante admin se o email estiver na lista\n    if (isAdminEmail(user.email) && user.role !== \"ADMIN\") {\n      try {\n        await prisma.user.update({\n          where: { id: user.id },\n          data: { role: \"ADMIN\" },\n        });\n        user.role = \"ADMIN\";\n      } catch (dbErr: any) {\n        console.error(\"LOGIN_DB_ADMIN_UPDATE_ERROR:\", dbErr);\n        // não bloqueia login por isso\n      }\n    }\n\n    // ✅ cria sessão\n    let sessionToken = \"\";\n    let expires = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000);\n    try {\n      const s = await createSession(user.id);\n      sessionToken = s.sessionToken;\n      expires = s.expires;\n    } catch (dbErr: any) {\n      console.error(\"LOGIN_DB_SESSION_ERROR:\", dbErr);\n      return NextResponse.json(\n        {\n          success: false,\n          error: \"Não foi possível criar sessão (banco indisponível). Tente novamente.\",\n          details: dbErr?.message || String(dbErr),\n        },\n        { status: 503 }\n      );\n    }\n\n    // ✅ seta cookie na resposta (mais confiável)\n    const res = NextResponse.json({\n      success: true,\n      user: { id: user.id, name: user.name, email: user.email, role: user.role },\n    });\n\n    res.cookies.set(\"studai_session\", sessionToken, {\n      httpOnly: true,\n      sameSite: \"lax\",\n      secure: process.env.NODE_ENV === \"production\",\n      path: \"/\",\n      expires,\n    });\n\n    return res;\n  } catch (err: any) {\n    console.error(\"LOGIN_ERROR:\", err);\n    return NextResponse.json(\n      { success: false, error: \"Erro ao fazer login.\", details: err?.message || String(err) },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}